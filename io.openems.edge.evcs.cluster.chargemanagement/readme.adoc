# Evcs Cluster Chargemanagement


cle 2023.12.03

Fuer simulationen gilt: config.stepInterval() mindestens 2

ecl








## Functionality

*Provides*

* (x) load management by leveling 
* (x) load management by round robin
* (x) chargepoint priorities - configured within each used chargepoint
* (x) phase balancing against gridmeter
* () supports several supply cable limits
* () pv optimized charge
* () better performance around or less than activePower <= 0W 
* () ludicrousMode - full load charging for 15min


*Constraints:*

* () fuseLimit[A] (phase based) (Grid) - should never be reached
* () fuseSafetyOffset[A] (phase based) - distance between fuse limit and safe operation mode
* () targetPower[W] (three phase based) - is always 4kw below (fuseLimit-fuseSafetyOffset)

* () targetPower - expected operation power of charge park. if current power > targetpower it will be downpowered within 30-60s   


* () SupplyCableResidualLimitL1-L3 (channel)  current between meter and a defined fuse on a specific segment of the supply cable 
      (with or without other consumers/producers 



Neue Controller definieren 


targetPower am Netz M1  -> 
supplyCablePower am M2


l1 = freie verfügbare leistung an M1
l2 = freie verfügbare leistung an M2
l3 = freie verfügbare leistung an M3  
  
lx liefert freeAndAvailablePower <-> misst gegen die targetPower
lx liefert notaus 


Phasenschieflast 



 
freePower = min(l1,l2, l3) = gegen Target 



## TODOs

* () safetyLimit = fuseLimit -10A, switching to state red









* () to be fixed - targetPower should go on power not on max(phaseL1-L3)*230
* () to be fixed - must be configurable via OpenEMS UI without ending in a cycle loop 
* () must be controllable from another `EvcsClusterFairshare` controller.
* () only cluster with componentId `evcsClusterFair...` can be referenced within other EvcsClusterFairShare component.
		


## Configuration

* `allowCharging`[true|false] - set to false to disable the full chargepark.
* `evcsIds` - the list of evcs IDs to control.
* `meterId` - the meter against which is regulated.
* `fuseLimit`[A] - the fuse hard limit (this is a per phase limit).  
* `targetPower`[W] - controller tries to hold all charge stations at this power level. Note: this is a power limit for all three phases.
* `phaseImbalanceCurrent`[A] - the max. phase imbalance current in A (20 = 4.5kW), see VDE-AR-N 4105. 
* `redHoldTime`[s] - when in state red, the state will stay for this number of seconds before switching back to state yellow.
* `roundRobinTime`[s] - cycle time for round robin activity.
* `unbalancedHoldTime`[s] - max unbalance time before switching a) from leveling to round robin or b) to cycle round robin, in case phase imbalance can not be resolve.
* `currentStep`[A] - size of a current decrement/increment step (per phase). 1A on 10 three phase charging chargepoints means 30A = 3*10*1A. Be careful when changing this.  
* `stepInterval`[s] - delay until next increment/decrement step.


*NOTE:* controller will go to state red 10A below fuselimit, this is called safelimit


## Description 

*State Red -> Yellow*

*State Yellow -> Green*

*State Yellow -> Red*


### State Green

*State Green - on Entry*

* set all EVCS to MinPower

*State Green -> Yellow*

* immediately when `config.safetyLimit` is exceeded on at least one phase
* when we are unbalanced for at least `config.unbalancedHoldTme` 


*State Green -> Red*

* when fuse limit is exceeded on at least one phase
* when channel `AllowCharging` is switched off (via `CtrlFixDigitalOutput`) 
* when we have any faults




## Limit Handling 

* `FixedMinimumHardwarePower`  - always `Evcs.MIN_HARDWARE_POWER` 
* `FixedMaximumHardwarePower`  - configured limit of this controller. It represents the `safetyLimit` as power value.
* `MinimumHardwarePower`       - always `Evcs.MIN_HARDWARE_POWER`
* `MaximumHardwarePower`       - sum of MaxHardwarePower of all connected EVCS, limited to `FixedMaxHardwarePower`   
* `MinimumPower`               - not defined
* `MaximumPower`               - not defined 
                        

## Cluster c2 controls Cluster c1  

Each cluster behaves like a chargepoint therefore it can be controlled by another cluster. 
A cluster `c2` can control one (or more) cluster `c1`. `c2` controls `c1` by setting the 
`c1.SetChargePowerLimit` channel.
Cluster `c1` uses this information to adopt the `safetyLimit` to this level and to automatically
set a `targetPower` which is related to `safetyLimit` but which is slightly lower.

 
## Minimum distance between "targetPower" and "safetyLimit"                          

Due to the control mechanism of the state `GREEN` handler, there should be a minimum distance betwwen
"targetPower" and "safetyLimit". The state `GREEN` handler reduces/increases the limits of all
chargepoints by 1 A and he is moving around "targetPower" we need a distance of 

  Power p = (number of chargepoints) * 3 (number of phases) * 2 (2 steps, one above target power and one below safety limit) * 230 V 

Having four charging chargepoints, we need to have a distance of `4 * 3 * 2 * 230 = 5.52kW` between `targetPower` and `safetyLimit`. 


		

## Channels
    
*Writable Channels:*

* `evcsClusterCharge0/SetChargePowerLimit` - Can be used to modify the `targetPower` of the fair share cluster.
* `evcsClusterCharge0/AllowCharging` - set to false will set the cluster controller to the state `RED`.

*Output:*

* `evcsClusterCharge0/ClusterState`
* `evcsClusterCharge0/NumberOfEvcs`
* `evcsClusterCharge0/NumberOfEvcsPrio`
* `evcsClusterCharge0/NumberOfChargingEvcs`
* `evcsClusterCharge0/NumberOfChargingEvcsPrio`
* `evcsClusterCharge0/EvcsPowerLimit`
* `evcsClusterCharge0/EvcsPowerLimitPrio`
* `evcsClusterCharge0/MeterCurrentL1`
* `evcsClusterCharge0/MeterCurrentL2`
* `evcsClusterCharge0/MeterCurrentL3`
* `evcsClusterCharge0/AllowCharging`
* `evcsClusterCharge0/RoundRobinAllowedChargeSessions`
* `evcsClusterCharge0/PhaseImbalance`
* `evcsClusterCharge0/PhaseImbalanceCurrent`

* evcsClusterCharge0/MinimumPower
* evcsClusterCharge0/FixedMinimumHardwarePower
* evcsClusterCharge0/MaximumPower
* evcsClusterCharge0/FixedMaximumHardwarePower
* evcsClusterCharge0/ChargePower
* evcsClusterCharge0/Current
* evcsClusterCharge0/CurrentL1
* evcsClusterCharge0/CurrentL2
* evcsClusterCharge0/CurrentL3
* evcsClusterCharge0/ActiveConsumptionEnergy
* evcsClusterCharge0/Status
		

*Error Channels:*

* evcsClusterCharge0/MeterError

		
	
*Internal States:*

* green    - charge management by leveling
* yellow   - charge management by round robin
* red      - all off
	
	

		
		
		
```mermaid		
stateDiagram-v2
    [*] --> Red
    Red --> Red
    Red --> Yellow: redHoldtime 
    Yellow --> Green: below safety limit AND no disabled chargesession 
    Green --> Yellow: above safetyLimit 
    Yellow --> Red: above safetyLimit 
```

View using Mermaid, e.g. https://mermaid-js.github.io/mermaid-live-editor		



https://github.com/OpenEMS/openems/tree/develop/io.openems.edge.evcs.cluster.chargemanagement[Source Code icon:github[]]
